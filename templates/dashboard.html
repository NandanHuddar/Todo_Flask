{% extends "base.html" %}

{% block title %}To-Do List App - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Tasks Area -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white">My Tasks</h5>
                <button class="btn btn-light btn-sm" id="add-task-btn" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                    <i class="fas fa-plus me-1"></i> Add Task
                </button>
            </div>
            <div class="card-body">
                <div id="tasks-container">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">Add New Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="new-task-form">
                    <div class="mb-3">
                        <label for="task-title" class="form-label fw-medium">Title</label>
                        <input type="text" class="form-control" id="task-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="task-details" class="form-label fw-medium">Details</label>
                        <textarea class="form-control" id="task-details" rows="3" placeholder="Optional"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="task-due-date" class="form-label fw-medium">Due Date</label>
                            <input type="text" class="form-control" id="task-due-date" placeholder="dd/mm">
                        </div>
                        <div class="col-6">
                            <label for="task-due-time" class="form-label fw-medium">Time</label>
                            <input type="text" class="form-control" id="task-due-time" placeholder="HH:MM">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Add Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">Edit Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="edit-task-form">
                    <input type="hidden" id="edit-task-id">
                    <div class="mb-3">
                        <label for="edit-task-title" class="form-label fw-medium">Title</label>
                        <input type="text" class="form-control" id="edit-task-title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-task-details" class="form-label fw-medium">Details</label>
                        <textarea class="form-control" id="edit-task-details" rows="3" placeholder="Optional"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="edit-task-due-date" class="form-label fw-medium">Due Date</label>
                            <input type="text" class="form-control" id="edit-task-due-date" placeholder="dd/mm">
                        </div>
                        <div class="col-6">
                            <label for="edit-task-due-time" class="form-label fw-medium">Time</label>
                            <input type="text" class="form-control" id="edit-task-due-time" placeholder="HH:MM">
                        </div>
                    </div>
                    <div class="form-check mb-3 p-3 rounded-3" style="background-color: #f8f9fa;">
                        <input type="checkbox" class="form-check-input" id="edit-task-completed">
                        <label class="form-check-label fw-medium" for="edit-task-completed">Mark as completed</label>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-outline-danger" id="delete-task-btn">Delete Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check authentication
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        // Set up axios default headers
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        
        // Load tasks
        loadTasks();
    });
    
    // Load tasks
    async function loadTasks() {
        try {
            // Show loading state
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading tasks...</p>
                </div>
            `;
            
            // Ensure axios is properly initialized with the token
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to view tasks');
                window.location.href = '/login';
                return;
            }
            
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
            const response = await axios.get('/api/tasks');
            const tasks = response.data;
            
            // Display tasks
            tasksContainer.innerHTML = '';
            
            if (tasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No tasks yet. Click "Add Task" to get started.</p>
                    </div>
                `;
                return;
            }
            
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `task-item mb-2 p-3 rounded-3 ${task.completed ? 'completed' : ''}`;
                taskCard.style.cssText = `
                    background: white;
                    border: 1px solid #e5e5ea;
                    transition: all 0.2s ease;
                    cursor: pointer;
                `;
                
                // Format due date if exists
                let dueDateDisplay = '';
                if (task.due_date) {
                    const dueDate = new Date(task.due_date);
                    const now = new Date();
                    const isOverdue = dueDate < now && !task.completed;
                    const isToday = dueDate.toDateString() === now.toDateString();
                    
                    let dateClass = 'text-muted';
                    if (isOverdue) dateClass = 'text-danger';
                    else if (isToday) dateClass = 'text-warning';
                    
                    dueDateDisplay = `
                        <div class="${dateClass} small mt-1">
                            <i class="fas fa-clock me-1"></i>
                            ${dueDate.toLocaleDateString()} ${dueDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    `;
                }
                
                taskCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 ${task.completed ? 'text-decoration-line-through text-muted' : ''}" style="font-weight: 500;">
                                ${task.title}
                            </h6>
                            ${task.details ? `<p class="mb-1 text-muted small">${task.details}</p>` : ''}
                            ${dueDateDisplay}
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary edit-task-btn" data-task-id="${task.id}" style="border-radius: 20px;">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add hover effects
                taskCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    this.style.borderColor = '#007aff';
                });
                
                taskCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                    this.style.borderColor = '#e5e5ea';
                });
                
                if (task.completed) {
                    taskCard.style.opacity = '0.6';
                }
                
                tasksContainer.appendChild(taskCard);
                
                // Add event listener to edit button
                taskCard.querySelector('.edit-task-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditTaskModal(task);
                });
            });
        } catch (error) {
            console.error('Error loading tasks:', error);
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading tasks. Please try again.
                </div>
            `;
        }
    }
    
    // Open edit task modal with task data
    function openEditTaskModal(task) {
        document.getElementById('edit-task-id').value = task.id;
        document.getElementById('edit-task-title').value = task.title;
        document.getElementById('edit-task-details').value = task.details || '';
        document.getElementById('edit-task-completed').checked = task.completed;
        
        // Set due date and time if exists
        const dueDateInput = document.getElementById('edit-task-due-date');
        const dueTimeInput = document.getElementById('edit-task-due-time');
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const day = String(dueDate.getDate()).padStart(2, '0');
            const month = String(dueDate.getMonth() + 1).padStart(2, '0');
            const hours = String(dueDate.getHours()).padStart(2, '0');
            const minutes = String(dueDate.getMinutes()).padStart(2, '0');
            
            dueDateInput.value = `${day}/${month}`;
            dueTimeInput.value = `${hours}:${minutes}`;
        } else {
            dueDateInput.value = '';
            dueTimeInput.value = '';
        }
        
        // Show the modal
        const editTaskModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        editTaskModal.show();
    }
    
    // Helper function to parse date from dd/mm format
    function parseCustomDate(dateStr, timeStr) {
        if (!dateStr) return null;
        
        const dateParts = dateStr.split('/');
        if (dateParts.length !== 2) return null;
        
        const day = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
        const currentYear = new Date().getFullYear();
        
        if (isNaN(day) || isNaN(month) || day < 1 || day > 31 || month < 0 || month > 11) {
            return null;
        }
        
        let hours = 0, minutes = 0;
        if (timeStr) {
            const timeParts = timeStr.split(':');
            if (timeParts.length === 2) {
                hours = parseInt(timeParts[0]);
                minutes = parseInt(timeParts[1]);
                
                if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    hours = 0;
                    minutes = 0;
                }
            }
        }
        
        return new Date(currentYear, month, day, hours, minutes);
    }
    
    // Create new task
    document.getElementById('new-task-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
        submitBtn.disabled = true;
        
        const title = document.getElementById('task-title').value;
        const details = document.getElementById('task-details').value;
        const dueDate = document.getElementById('task-due-date').value;
        const dueTime = document.getElementById('task-due-time').value;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to create a task');
                window.location.href = '/login';
                return;
            }
            
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
            const taskData = {
                title: title,
                details: details
            };
            
            if (dueDate && dueTime) {
                const parsedDate = parseCustomDate(dueDate, dueTime);
                if (parsedDate) {
                    taskData.due_date = parsedDate.toISOString();
                } else {
                    alert('Please enter date in dd/mm format and time in HH:MM format');
                    return;
                }
            } else if (dueDate) {
                const parsedDate = parseCustomDate(dueDate, '00:00');
                if (parsedDate) {
                    taskData.due_date = parsedDate.toISOString();
                } else {
                    alert('Please enter date in dd/mm format');
                    return;
                }
            }
            
            await axios.post('/api/tasks', taskData);
            
            // Close modal
            const modalElement = document.getElementById('newTaskModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modal.hide();
            
            // Reset form
            document.getElementById('new-task-form').reset();
            
            // Reload tasks
            loadTasks();
        } catch (error) {
            console.error('Error creating task:', error);
            alert(`Error creating task: ${error.response ? error.response.data.message || 'Server error' : 'Network error'}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Edit task
    document.getElementById('edit-task-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        submitBtn.disabled = true;
        
        const taskId = document.getElementById('edit-task-id').value;
        const title = document.getElementById('edit-task-title').value;
        const details = document.getElementById('edit-task-details').value;
        const dueDate = document.getElementById('edit-task-due-date').value;
        const dueTime = document.getElementById('edit-task-due-time').value;
        const completed = document.getElementById('edit-task-completed').checked;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to edit a task');
                window.location.href = '/login';
                return;
            }
            
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
            const taskData = {
                title: title,
                details: details,
                completed: completed
            };
            
            if (dueDate && dueTime) {
                const parsedDate = parseCustomDate(dueDate, dueTime);
                if (parsedDate) {
                    taskData.due_date = parsedDate.toISOString();
                } else {
                    alert('Please enter date in dd/mm format and time in HH:MM format');
                    return;
                }
            } else if (dueDate) {
                const parsedDate = parseCustomDate(dueDate, '00:00');
                if (parsedDate) {
                    taskData.due_date = parsedDate.toISOString();
                } else {
                    alert('Please enter date in dd/mm format');
                    return;
                }
            } else {
                taskData.due_date = null;
            }
            
            await axios.put(`/api/tasks/${taskId}`, taskData);
            
            // Close modal
            const modalElement = document.getElementById('editTaskModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modal.hide();
            
            // Reload tasks
            loadTasks();
        } catch (error) {
            console.error('Error updating task:', error);
            alert(`Error updating task: ${error.response ? error.response.data.message || 'Server error' : 'Network error'}`);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
    
    // Delete task
    document.getElementById('delete-task-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const taskId = document.getElementById('edit-task-id').value;
        if (!taskId) {
            console.error('No task ID found');
            alert('Error: Could not identify the task to delete');
            return;
        }
        
        if (confirm('Are you sure you want to delete this task?')) {
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            this.disabled = true;
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No authentication token found');
                    alert('You must be logged in to delete a task');
                    window.location.href = '/login';
                    return;
                }
                
                axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                
                const response = await axios.delete(`/api/tasks/${taskId}`);
                
                if (response.status !== 200) {
                    throw new Error(`Server returned status ${response.status}`);
                }
                
                // Close modal
                const modalElement = document.getElementById('editTaskModal');
                if (modalElement) {
                    try {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        } else {
                            const newModal = new bootstrap.Modal(modalElement);
                            newModal.hide();
                        }
                    } catch (modalError) {
                        console.error('Error with Bootstrap modal:', modalError);
                        modalElement.classList.remove('show');
                        modalElement.style.display = 'none';
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                        document.body.classList.remove('modal-open');
                    }
                }
                
                // Reload tasks
                await loadTasks();
                
            } catch (error) {
                console.error('Error deleting task:', error);
                
                let errorMessage = 'An error occurred while deleting the task';
                if (error.response) {
                    errorMessage = error.response.data.message || 'Server error';
                } else if (error.request) {
                    errorMessage = 'Network error - could not reach the server';
                } else {
                    errorMessage = error.message;
                }
                
                alert(`Error deleting task: ${errorMessage}`);
            } finally {
                this.innerHTML = originalText;
                this.disabled = false;
            }
        }
    });
</script>

<style>
.task-item {
    transition: all 0.2s ease;
    border: 1px solid #e5e5ea !important;
}

.task-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-color: #007aff !important;
}

.task-item.completed {
    background-color: #f8f9fa !important;
    opacity: 0.7;
}

.btn-outline-primary {
    border-color: #007aff;
    color: #007aff;
}

.btn-outline-primary:hover {
    background-color: #007aff;
    border-color: #007aff;
}

.btn-outline-danger {
    border-color: #ff3b30;
    color: #ff3b30;
}

.btn-outline-danger:hover {
    background-color: #ff3b30;
    border-color: #ff3b30;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>
{% endblock %}